<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>#DASP# Short Addresses (9) -</title><meta name=Description content="This is Houugen's Hugo Site"><meta property="og:title" content="#DASP# Short Addresses (9)"><meta property="og:description" content="0x00 Info 短地址攻击是DASP TOP10中详细描述的最后一类漏洞。这个漏洞其实可以归结于过去EVM的缺陷。
0x01 基础知识 Quote  The Contract Application Binary Interface (ABI) is the standard way to interact with contracts in the Ethereum ecosystem, both from outside the blockchain and for contract-to-contract interaction.   在EVM虚拟机中合约是通过ABI接口进行交互，数据和方法都根据特定标准进行编解码。具体参见Contract ABI Specification。
如何通过ABI调用合约方法？方法和数据如何编码？我们举例（经典Token合约）来说明：
contract MyToken { mapping (address => uint) balances; event Transfer(address indexed _from, address indexed _to, uint256 _value); function MyToken() { balances[tx.origin] = 10000; } function sendCoin(address to, uint amount) returns(bool sufficient) { if (balances[msg."><meta property="og:type" content="article"><meta property="og:url" content="http://houugen.fun/posts/dasp-short-addresses-9.html"><meta property="article:published_time" content="2018-08-20T15:40:14+00:00"><meta property="article:modified_time" content="2018-08-20T15:40:14+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="#DASP# Short Addresses (9)"><meta name=twitter:description content="0x00 Info 短地址攻击是DASP TOP10中详细描述的最后一类漏洞。这个漏洞其实可以归结于过去EVM的缺陷。
0x01 基础知识 Quote  The Contract Application Binary Interface (ABI) is the standard way to interact with contracts in the Ethereum ecosystem, both from outside the blockchain and for contract-to-contract interaction.   在EVM虚拟机中合约是通过ABI接口进行交互，数据和方法都根据特定标准进行编解码。具体参见Contract ABI Specification。
如何通过ABI调用合约方法？方法和数据如何编码？我们举例（经典Token合约）来说明：
contract MyToken { mapping (address => uint) balances; event Transfer(address indexed _from, address indexed _to, uint256 _value); function MyToken() { balances[tx.origin] = 10000; } function sendCoin(address to, uint amount) returns(bool sufficient) { if (balances[msg."><meta name=application-name content><meta name=apple-mobile-web-app-title content><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://houugen.fun/posts/dasp-short-addresses-9.html><link rel=prev href=http://houugen.fun/posts/dasp-time-manipulation-8.html><link rel=next href=http://houugen.fun/posts/blockchain-wordcloud.html><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"#DASP# Short Addresses (9)","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/houugen.fun\/posts\/dasp-short-addresses-9.html"},"genre":"posts","keywords":"BlockChain, DASP","wordcount":139,"url":"http:\/\/houugen.fun\/posts\/dasp-short-addresses-9.html","datePublished":"2018-08-20T15:40:14+00:00","dateModified":"2018-08-20T15:40:14+00:00","publisher":{"@type":"Organization","name":"Houugen"},"author":{"@type":"Person","name":"Houugen"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/>Houugen<span class=header-title-post>モブ</span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/>Houugen<span class=header-title-post>モブ</span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/>Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">#DASP# Short Addresses (9)</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Houugen</a></span>&nbsp;<span class=post-category>included in <a href=/categories/%E5%8C%BA%E5%9D%97%E9%93%BE.html><i class="far fa-folder fa-fw"></i>区块链</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2018-08-20>2018-08-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;139 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;One minute&nbsp;<span id=/posts/dasp-short-addresses-9.html class=leancloud_visitors data-flag-title="#DASP# Short Addresses (9)">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#0x00-info>0x00 Info</a></li><li><a href=#0x01-基础知识>0x01 基础知识</a></li><li><a href=#0x02-攻击利用>0x02 攻击利用</a></li></ul></nav></div></div><div class=content id=content><h2 id=0x00-info>0x00 Info</h2><p><a href=https://www.dasp.co/#item-8 target=_blank rel="noopener noreffer">短地址攻击</a>是DASP TOP10中详细描述的最后一类漏洞。这个漏洞其实可以归结于过去EVM的缺陷。</p><h2 id=0x01-基础知识>0x01 基础知识</h2><div class="details admonition quote open"><div class="details-summary admonition-title"><i class="icon fas fa-quote-right fa-fw"></i>Quote<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>The Contract Application Binary Interface (ABI) is the standard way to interact with contracts in the Ethereum ecosystem, both from outside the blockchain and for contract-to-contract interaction.</div></div></div><p>在EVM虚拟机中合约是通过ABI接口进行交互，数据和方法都根据特定标准进行编解码。具体参见<a href=https://solidity.readthedocs.io/en/develop/abi-spec.html target=_blank rel="noopener noreffer">Contract ABI Specification</a>。</p><p>如何通过ABI调用合约方法？方法和数据如何编码？我们举例（经典Token合约）来说明：</p><div class=highlight><pre class=chroma><code class=language-solidity data-lang=solidity><span class=kd>contract</span> <span class=n>MyToken</span> <span class=p>{</span>
    <span class=kd>mapping</span> <span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint</span><span class=p>)</span> <span class=n>balances</span><span class=p>;</span>
 
    <span class=kd>event</span> <span class=n>Transfer</span><span class=p>(</span><span class=kt>address</span> <span class=kr>indexed</span> <span class=n>_from</span><span class=p>,</span> <span class=kt>address</span> <span class=kr>indexed</span> <span class=n>_to</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>_value</span><span class=p>);</span>
 
    <span class=kd>function</span> <span class=n>MyToken</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>balances</span><span class=p>[</span><span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span><span class=p>]</span> <span class=o>=</span> <span class=mi>10000</span><span class=p>;</span>
    <span class=p>}</span>
 
    <span class=kd>function</span> <span class=n>sendCoin</span><span class=p>(</span><span class=kt>address</span> <span class=n>to</span><span class=p>,</span> <span class=kt>uint</span> <span class=n>amount</span><span class=p>)</span> <span class=k>returns</span><span class=p>(</span><span class=kt>bool</span> <span class=n>sufficient</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>amount</span><span class=p>)</span> <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
        <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>-=</span> <span class=n>amount</span><span class=p>;</span>
        <span class=n>balances</span><span class=p>[</span><span class=n>to</span><span class=p>]</span> <span class=o>+=</span> <span class=n>amount</span><span class=p>;</span>
        <span class=n>Transfer</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=n>to</span><span class=p>,</span> <span class=n>amount</span><span class=p>);</span>
        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
    <span class=p>}</span>
 
    <span class=kd>function</span> <span class=n>getBalance</span><span class=p>(</span><span class=kt>address</span> <span class=n>addr</span><span class=p>)</span> <span class=kr>constant</span> <span class=k>returns</span><span class=p>(</span><span class=kt>uint</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>balances</span><span class=p>[</span><span class=n>addr</span><span class=p>];</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>如果我们想转币到其他地址，会外部调用sendCoin()方法，则创建交易后查看input数据如下：
<img class=lazyload src=/svg/loading.min.svg data-src=DASP-Short-Addresses-9/1.png data-srcset="DASP-Short-Addresses-9/1.png, DASP-Short-Addresses-9/1.png 1.5x, DASP-Short-Addresses-9/1.png 2x" data-sizes=auto alt=DASP-Short-Addresses-9/1.png title=DASP-Short-Addresses-9/1.png>
展开为：
<img class=lazyload src=/svg/loading.min.svg data-src=DASP-Short-Addresses-9/2.png data-srcset="DASP-Short-Addresses-9/2.png, DASP-Short-Addresses-9/2.png 1.5x, DASP-Short-Addresses-9/2.png 2x" data-sizes=auto alt=DASP-Short-Addresses-9/2.png title=DASP-Short-Addresses-9/2.png></p><ul><li><code>0x90b98a11</code> 方法签名的hash值，4个字节，通过Keccak(sendCoin(address, uint))计算得到</li><li><code>00000000000000000000000062bec9abe373123b9b635b75608f94eb8644163e</code> &lsquo;to&rsquo;地址，20个字节，填充前导0（12字节）至32字节</li><li><code>0000000000000000000000000000000000000000000000000000000000000002</code> &lsquo;amount&rsquo;数量，1字节无符号整型，填充前导0（31字节）至32字节</li></ul><p>input就是一笔完整的交易数据。</p><h2 id=0x02-攻击利用>0x02 攻击利用</h2><p>17年Golem团队发现一笔<a href=https://etherscan.io/tx/0x0213fb70e8174c5cbd9233a8e95905462cd7f1b498c12ff5e8ec071f4cc99347 target=_blank rel="noopener noreffer">可疑的GNT交易</a>，从而发现了短地址漏洞。<a href=https://blog.golemproject.net/how-to-find-10m-by-just-reading-blockchain-6ae9d39fcd95 target=_blank rel="noopener noreffer">How to Find $10M Just by Reading the Blockchain</a>一文中详细描述了漏洞的发现和利用。</p><p>我们还是以上面的例子分析下漏洞成因。</p><div class="details admonition question open"><div class="details-summary admonition-title"><i class="icon fas fa-question-circle fa-fw"></i>Question<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>EVM和合约如果未校验用户输入会产生什么效果？</div></div></div><p>我们把&rsquo;to&rsquo;地址的32字节最后1字节去掉，变成<code>0x62bec9abe373123b9b635b75608f94eb864416</code>，那此时input数据就会变成：</p><pre><code>0x90b98a11
00000000000000000000000062bec9abe373123b9b635b75608f94eb86441600
00000000000000000000000000000000000000000000000000000000000002
</code></pre><p>第一个参数不足32字节会从第二参数高位取0补位，这样第二个参数就被左移1字节，相当于<code>amount * 256</code>。</p><p>交易瞬间变成了:</p><pre><code> from: '0x8b349f26a49a45776a1ec0d0188e7a89367c8c5d',
   to: '0x62bec9abe373123b9b635b75608f94eb86441600',
value: 512,
</code></pre><p>该漏洞能够成功利用的大前提是：</p><ol><li>币充足</li><li>在构成input数据时用户的输入和填充没有进行校验（在remix中实验失败就是因为已经不允许传入非法短地址了）</li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2018-08-20</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/blockchain.html>BlockChain</a>,&nbsp;<a href=/tags/dasp.html>DASP</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/dasp-time-manipulation-8.html class=prev rel=prev title="#DASP# Time Manipulation (8)"><i class="fas fa-angle-left fa-fw"></i>#DASP# Time Manipulation (8)</a>
<a href=/posts/blockchain-wordcloud.html class=next rel=next title="Blockchain WordCloud">Blockchain WordCloud<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2020</span>&nbsp;|&nbsp;<span class=license>Houugen</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":20},"comment":{"valine":{"appId":"QhRivi4Qm3PjvD0WoqEiJv5n-gzGzoHsz","appKey":"gHPJRKJ7Vfi2xHjiJ3AcP92S","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"en","pageSize":10,"placeholder":"Your comment ...","recordIP":true,"serverURLs":"https://leancloud.cn","visitor":true}},"search":{"algoliaAppID":"63ROI1DYLO","algoliaIndex":"houugen_blog","algoliaSearchKey":"0282c2777b386667ccc099a27da8a3cb","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>